{% extends "base.html" %}
{% block content %}

<h1 class="mb-4">Cyber Threat Intelligence Dashboard</h1>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-bg-primary mb-3">
      <div class="card-body text-center">
        <h5 class="card-title">Total IOCs</h5>
        <p class="card-text fs-2 mb-0">{{ total_iocs }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-danger mb-3">
      <div class="card-body text-center">
        <h5 class="card-title">Malicious</h5>
        <p class="card-text fs-2 mb-0">{{ malicious_iocs }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-success mb-3">
      <div class="card-body text-center">
        <h5 class="card-title">Harmless</h5>
        <p class="card-text fs-2 mb-0">{{ harmless_iocs }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-warning mb-3">
      <div class="card-body text-center">
        <h5 class="card-title">Suspicious</h5>
        <p class="card-text fs-2 mb-0">{{ suspicious_iocs }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row mb-5">
  <div class="col-md-6">
    <h3 class="mb-3">Threat Breakdown</h3>
    <canvas id="threatChart"></canvas>
  </div>
  <div class="col-md-6">
    <h3 class="mb-3">Recent Lookups</h3>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Type</th>
          <th>Value</th>
          <th>Malicious</th>
          <th>Harmless</th>
          <th>Suspicious</th>
          <th>Time (UTC)</th>
        </tr>
      </thead>
      <tbody>
        {% for doc in recent %}
        <tr>
          <td>{{ doc.ioc_type|upper }}</td>
          <td>{{ doc.value }}</td>
          <td>{{ doc.parsed.malicious if doc.parsed }}</td>
          <td>{{ doc.parsed.harmless if doc.parsed }}</td>
          <td>{{ doc.parsed.suspicious if doc.parsed }}</td>
          <td>{{ doc.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const ctx = document.getElementById('threatChart');
  const chartLabels = {{ chart_labels | tojson }};
  const chartValues = {{ chart_values | tojson }};

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: chartLabels,
      datasets: [{
        data: chartValues
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
</script>
{% endblock %}
